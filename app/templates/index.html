{% extends "base.html" %}

{% block title %}Groundwork | City Transport Intelligence{% endblock %}

{% block meta %}
{% set base_url = request.url.scheme ~ "://" ~ request.url.netloc %}
<meta name="description" content="Reference-grade city transport intelligence for business travelers. Search transit options, payment methods, operating hours, and airport connections across cities worldwide.">
<meta property="og:title" content="Groundwork | City Transport Intelligence">
<meta property="og:description" content="Reference-grade city transport intelligence for business travelers. Search transit options, payment methods, operating hours, and airport connections across cities worldwide.">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Groundwork by Potniq">
<meta property="og:image" content="{{ base_url }}/static/groundwork_logo.png">
<meta property="og:url" content="{{ base_url }}/">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Groundwork | City Transport Intelligence">
<meta name="twitter:description" content="Reference-grade city transport intelligence for business travelers.">
<meta name="twitter:image" content="{{ base_url }}/static/groundwork_logo.png">
{% endblock %}

{% block content %}
<section class="landing-panel">
    <div class="hero-brand">
        <img class="hero-logo" src="/static/groundwork_logo.png" alt="Groundwork">
        <div class="hero-text">
            <span class="hero-name">Groundwork</span>
            <span class="hero-sub">by Potniq</span>
        </div>
    </div>
    <div class="hero-copy">
        <p class="eyebrow">Reference-grade transit notes*</p>
        <h1>City transport intelligence for business travelers</h1>
        <p class="subdued">Search for a city to see transport options, payment methods, operating patterns, and airport connections.</p>
    </div>
</section>

<section class="search-panel">
    <label for="city-search">Search cities</label>
    <input id="city-search" type="search" placeholder="Type city or country..." autocomplete="off">
</section>

{% if cities %}
<section class="card-grid" id="city-grid">
    {% for city in cities %}
    <article class="city-card" data-search="{{ (city.city_name ~ ' ' ~ city.country)|lower }}">
        <h2 class="city-card-title">
            <a href="/{{ city.slug }}">{{ city.city_name }}, {{ city.country }}</a>
            <span class="flag">{{ city.flag }}</span>
        </h2>
        <ul class="facts">
            <li><span>Metro</span><strong class="{{ 'yes' if city.has_metro else 'no' }}">{{ ("&#10003;" if city.has_metro else "&#10005;")|safe }}</strong></li>
            <li><span>Contactless</span><strong class="{{ 'yes' if city.contactless else 'no' }}">{{ ("&#10003;" if city.contactless else "&#10005;")|safe }}</strong></li>
            <li><span>Rideshare</span><strong>{{ city.rideshare }}</strong></li>
        </ul>
        <a class="card-link" href="/{{ city.slug }}">Open guide</a>
    </article>
    {% endfor %}
</section>
<p id="empty-filter" class="empty-state panel hidden">No matching cities found.</p>
{% else %}
<section class="empty-state panel">
    <h2>No cities yet</h2>
    <p>Come back soon for city guides as we add them.</p>
</section>
{% endif %}

<section class="request-city panel">
    <div class="request-copy">
        <h2>Can't find your city?</h2>
        <p>Request a city and we'll review it for future coverage.</p>
    </div>
    <form id="city-request-form" class="request-form">
        <label for="request-raw-input">City name</label>
        <input id="request-raw-input" name="raw_input" type="text" required placeholder="e.g. Joburg or Portland Oregon">

        <label for="request-email">Email (optional)</label>
        <input id="request-email" name="email" type="email" placeholder="you@company.com">

        <button type="submit">Submit request</button>
    </form>
    <p id="request-feedback" class="subdued hidden" role="status" aria-live="polite"></p>
</section>

<script>
const searchInput = document.getElementById('city-search');
const cards = Array.from(document.querySelectorAll('.city-card'));
const emptyFilter = document.getElementById('empty-filter');
const requestForm = document.getElementById('city-request-form');
const requestFeedback = document.getElementById('request-feedback');

if (searchInput) {
  searchInput.addEventListener('input', (event) => {
    const query = event.target.value.trim().toLowerCase();
    let visibleCount = 0;

    cards.forEach((card) => {
      const searchable = card.dataset.search || '';
      const matches = searchable.includes(query);
      card.classList.toggle('hidden', !matches);
      if (matches) {
        visibleCount += 1;
      }
    });

    if (emptyFilter) {
      emptyFilter.classList.toggle('hidden', visibleCount > 0 || query.length === 0);
    }
  });
}

if (requestForm) {
  requestForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    const formData = new FormData(requestForm);
    const rawInput = String(formData.get('raw_input') || '').trim();
    const email = String(formData.get('email') || '').trim();

    if (!rawInput) {
      if (requestFeedback) {
        requestFeedback.textContent = 'Please enter a city.';
        requestFeedback.classList.remove('hidden');
      }
      return;
    }

    const payload = { raw_input: rawInput };
    if (email) {
      payload.email = email;
    }

    try {
      const response = await fetch('/requests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error('Request failed');
      }

      const data = await response.json();
      requestForm.reset();
      if (requestFeedback) {
        requestFeedback.textContent = data.message || 'Thanks, we received your city request.';
        requestFeedback.classList.remove('hidden');
      }
    } catch (_) {
      if (requestFeedback) {
        requestFeedback.textContent = 'Could not submit request right now. Please try again.';
        requestFeedback.classList.remove('hidden');
      }
    }
  });
}
</script>
{% endblock %}
