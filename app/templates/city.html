{% extends "base.html" %}

{% block title %}{{ city.city_name }} Transport Guide | Groundwork{% endblock %}

{% block meta %}
{% set page_title = city.city_name ~ " Transport Guide | Groundwork" %}
{% set page_description = "City transport intelligence for " ~ city.city_name ~ ", " ~ city.country ~ ". Transit authorities, payment methods, operating hours, rideshare options, and airport connections." %}
{% set base_url = request.url.scheme ~ "://" ~ request.url.netloc %}
<meta name="description" content="{{ page_description }}">
<meta property="og:title" content="{{ page_title }}">
<meta property="og:description" content="{{ page_description }}">
<meta property="og:type" content="article">
<meta property="og:site_name" content="Groundwork by Potniq">
<meta property="og:image" content="{{ base_url }}/static/groundwork_logo.png">
<meta property="og:url" content="{{ base_url }}/{{ city.slug }}">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="{{ page_title }}">
<meta name="twitter:description" content="{{ page_description }}">
<meta name="twitter:image" content="{{ base_url }}/static/groundwork_logo.png">
{% endblock %}

{% block content %}
<section class="city-hero panel">
    <div>
        <p class="eyebrow">City guide</p>
        <h1>{{ city.city_name }}, {{ city.country }} <span class="flag">{{ flag }}</span></h1>
        <p class="subdued">
            Status:
            <span class="status-pill {{ city.status }}">{{ city.status }}</span>
        </p>
        {% if city.retrieved_at %}
        <p class="subdued">Last refresh: {{ city.retrieved_at.strftime("%Y-%m-%d %H:%M UTC") }}</p>
        {% endif %}
    </div>
    <img class="city-hero-icon" src="/static/icon.svg" alt="Groundwork icon">
</section>

{% if intel %}
<section class="kpi-grid">
    <article class="kpi-card">
        <p class="kpi-label">Authorities</p>
        <p class="kpi-value">{{ intel.authorities|length }}</p>
    </article>
    <article class="kpi-card">
        <p class="kpi-label">Transport modes</p>
        <p class="kpi-value">{{ intel.modes|length }}</p>
    </article>
    <article class="kpi-card">
        <p class="kpi-label">Payment methods</p>
        <p class="kpi-value">{{ intel.payment_methods|length }}</p>
    </article>
    <article class="kpi-card">
        <p class="kpi-label">Airport links</p>
        <p class="kpi-value">{{ intel.airport_connections|length }}</p>
    </article>
</section>

<div class="city-layout">
    <section class="panel">
        <h2>Transport Authorities</h2>
        <div class="authority-list">
            {% for authority in intel.authorities %}
            <article class="authority-card">
                <p><strong>{{ authority.name }}</strong></p>
                <p><a href="{{ authority.website }}" target="_blank" rel="noopener noreferrer">Official website</a></p>
                {% set app_links = namespace(show=false) %}
                {% for app in authority.apps %}
                    {% if app.ios_url or app.android_url %}
                        {% set app_links.show = true %}
                    {% endif %}
                {% endfor %}
                {% if app_links.show %}
                <ul class="detail-list compact-list">
                    {% for app in authority.apps %}
                    {% if app.ios_url or app.android_url %}
                    <li>
                        <strong>{{ app.name }}</strong>
                        {% if app.ios_url %}
                        <a href="{{ app.ios_url }}" target="_blank" rel="noopener noreferrer">iOS</a>
                        {% endif %}
                        {% if app.android_url %}
                        <a href="{{ app.android_url }}" target="_blank" rel="noopener noreferrer">Android</a>
                        {% endif %}
                    </li>
                    {% endif %}
                    {% endfor %}
                </ul>
                {% elif authority.app %}
                <p class="subdued">App: {{ authority.app }}</p>
                {% endif %}
            </article>
            {% endfor %}
        </div>
    </section>

    <section class="panel">
        <h2>Getting Around</h2>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Mode</th>
                        <th>Operator</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mode in intel.modes %}
                    <tr>
                        <td>{{ mode.type }}</td>
                        <td>{{ mode.operator }}</td>
                        <td>{{ mode.notes }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <section class="panel">
        <h2>Paying for Transport</h2>
        <ul class="detail-list">
            {% for payment in intel.payment_methods %}
            <li>
                <strong>{{ payment.method }}</strong>
                <span>{{ payment.details }}</span>
                {% if payment.url %}
                <a href="{{ payment.url }}" target="_blank" rel="noopener noreferrer">Open</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </section>

    <section class="panel">
        <h2>Operating Hours</h2>
        <ul class="detail-list">
            <li><strong>Weekday</strong> <span>{{ intel.operating_hours.weekday }}</span></li>
            <li><strong>Weekend</strong> <span>{{ intel.operating_hours.weekend }}</span></li>
            {% if intel.operating_hours.night_service %}
            <li><strong>Night service</strong> <span>{{ intel.operating_hours.night_service }}</span></li>
            {% endif %}
        </ul>
    </section>

    <section class="panel">
        <h2>Rideshare &amp; Taxis</h2>
        <ul class="detail-list">
            {% for option in intel.rideshare %}
            <li>
                <strong>{{ option.provider }}</strong>
                <span class="badge {{ 'yes' if option.available else 'no' }}">{{ 'Available' if option.available else 'Not available' }}</span>
                <span>{{ option.notes }}</span>
            </li>
            {% endfor %}
        </ul>
    </section>

    <section class="panel">
        <h2>Airport Connections</h2>
        <ul class="detail-list">
            {% for connection in intel.airport_connections %}
            <li>
                <strong>{{ connection.mode }} - {{ connection.name }}</strong>
                <span>{{ connection.duration }}, {{ connection.cost }}</span>
                {% if connection.info_url %}
                <a href="{{ connection.info_url }}" target="_blank" rel="noopener noreferrer">Airport info</a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </section>

    <section class="panel">
        <h2>Live Delay Info</h2>
        <ul class="detail-list link-list">
            {% for source in intel.delay_info %}
            <li><a href="{{ source.url }}" target="_blank" rel="noopener noreferrer">{{ source.source }}</a></li>
            {% endfor %}
        </ul>
    </section>

    <section class="panel panel-full">
        <h2>Local Tips</h2>
        <p class="tip-box">{{ intel.tips }}</p>
    </section>
</div>
{% else %}
<section class="empty-state panel">
    <h2>Guide not ready</h2>
    <p>This city is still being generated.</p>
</section>
{% endif %}
{% endblock %}
