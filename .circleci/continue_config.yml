version: 2.1

parameters:
  run_workflow:
    type: boolean
    default: true

orbs:
  python: circleci/python@4.0.0
  snyk: snyk/snyk@2.3.0

jobs:
  install-deps:
    docker:
      - image: cimg/python:3.13
    steps:
      - checkout
      - restore_cache:
          keys:
            - v2-python-venv-{{ arch }}-{{ checksum "requirements.txt" }}
      - run:
          name: Create virtualenv
          command: |
            if [ ! -d .venv ]; then
              python -m venv .venv
            fi
            echo 'source "$(pwd)/.venv/bin/activate"' >> "$BASH_ENV"
      - python/install-packages:
          pkg-manager: pip
          pip-dependency-file: requirements.txt
          cache-version: v2
      - save_cache:
          key: v2-python-venv-{{ arch }}-{{ checksum "requirements.txt" }}
          paths:
            - .venv
      - persist_to_workspace:
          root: .
          paths:
            - .venv

  test-unit:
    docker:
      - image: cimg/python:3.13
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Run unit tests
          command: |
            source .venv/bin/activate
            mkdir -p test-results
            pytest -m unit tests/unit --junitxml=test-results/unit-results.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results

  test-integration:
    docker:
      - image: cimg/python:3.13
        environment:
          DATABASE_URL: postgresql://postgres@localhost:5432/groundwork_test
          ADMIN_API_KEY: test-key
          PERPLEXITY_API_KEY: test-key
      - image: cimg/postgres:18.0
        environment:
          POSTGRES_DB: groundwork_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ""
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Run migrations
          command: |
            source .venv/bin/activate
            chmod +x scripts/run_migrations.sh
            ./scripts/run_migrations.sh
      - run:
          name: Run integration tests
          command: |
            source .venv/bin/activate
            mkdir -p test-results
            pytest -m integration tests/integration --junitxml=test-results/integration-results.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results

  scan-python-deps:
    docker:
      - image: cimg/python:3.13
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Activate virtualenv for Snyk
          command: |
            echo 'source "$(pwd)/.venv/bin/activate"' >> "$BASH_ENV"
            source "$BASH_ENV"
            python --version
            pip --version
      - snyk/scan:
          target-file: requirements.txt
          severity-threshold: high
          monitor-on-build: false

  build-docker:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: false
      - run:
          name: Build Docker image
          command: |
            docker build \
              -t ${DOCKERHUB_REPO}:latest \
              -t ${DOCKERHUB_REPO}:${CIRCLE_SHA1} \
              .
      - run:
          name: Save Docker image to workspace
          command: |
            docker save -o /tmp/groundwork-api.tar ${DOCKERHUB_REPO}:latest ${DOCKERHUB_REPO}:${CIRCLE_SHA1}
      - persist_to_workspace:
          root: /tmp
          paths:
            - groundwork-api.tar

  push-docker:
    docker:
      - image: cimg/base:stable
    steps:
      - attach_workspace:
          at: /tmp
      - setup_remote_docker:
          docker_layer_caching: false
      - run:
          name: Load Docker image from workspace
          command: |
            docker load -i /tmp/groundwork-api.tar
      - run:
          name: Push Docker image to Docker Hub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push ${DOCKERHUB_REPO}:latest
            docker push ${DOCKERHUB_REPO}:${CIRCLE_SHA1}

  verify-docker:
    docker:
      - image: cimg/base:stable
    steps:
      - attach_workspace:
          at: /tmp
      - setup_remote_docker:
          docker_layer_caching: false
      - run:
          name: Load Docker image from workspace
          command: |
            docker load -i /tmp/groundwork-api.tar
      - run:
          name: Start container and verify health endpoint
          command: |
            echo "Starting container for runtime verification..."

            docker run -d --name groundwork-test \
              -e PORT=8080 \
              -e DATABASE_URL=sqlite:///tmp/groundwork.db \
              -e PERPLEXITY_API_KEY=test_key \
              -e ADMIN_API_KEY=test_key \
              ${DOCKERHUB_REPO}:latest

            for i in $(seq 1 30); do
              if ! docker ps -q --filter "name=groundwork-test" | grep -q .; then
                echo "Container exited before becoming healthy."
                docker logs groundwork-test || true
                exit 1
              fi

              if docker exec groundwork-test python -c 'import urllib.request,sys;resp=urllib.request.urlopen("http://127.0.0.1:8080/health", timeout=2);sys.exit(0 if resp.status==200 else 1)' >/dev/null 2>&1; then
                echo "Health endpoint returned HTTP 200 after ${i}s."
                docker logs groundwork-test | tail -n 50 || true
                docker stop groundwork-test >/dev/null 2>&1 || true
                exit 0
              fi

              echo "Waiting for app startup... ($i/30)"
              sleep 1
            done

            echo "Health check did not pass within timeout."
            docker logs groundwork-test || true
            docker stop groundwork-test >/dev/null 2>&1 || true
            exit 1

  scan-docker-image:
    docker:
      - image: cimg/base:stable
    steps:
      - attach_workspace:
          at: /tmp
      - setup_remote_docker:
          docker_layer_caching: false
      - run:
          name: Load Docker image from workspace
          command: |
            docker load -i /tmp/groundwork-api.tar
      - snyk/scan:
          docker-image-name: ${DOCKERHUB_REPO}:latest
          severity-threshold: high
          monitor-on-build: false

  run-production-migrations:
    docker:
      - image: cimg/node:20.19
    steps:
      - checkout
      - run:
          name: Run Supabase production migrations
          command: |
            npx --yes supabase@latest --version
            npx --yes supabase@latest db push --db-url "$SUPABASE_DB_URL" --include-all --yes

  deploy-digitalocean:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Install doctl
          command: |
            cd ~
            wget https://github.com/digitalocean/doctl/releases/download/v1.146.0/doctl-1.146.0-linux-amd64.tar.gz
            tar xf doctl-1.146.0-linux-amd64.tar.gz
            sudo mv doctl /usr/local/bin
      - run:
          name: Authenticate with DigitalOcean
          command: |
            doctl auth init --access-token "$DIGITALOCEAN_ACCESS_TOKEN"
      - run:
          name: Trigger DigitalOcean App Platform deployment
          command: |
            doctl apps create-deployment "$DIGITALOCEAN_APP_ID" --wait

workflows:
  ci:
    when: << pipeline.parameters.run_workflow >>
    jobs:
      - install-deps
      - test-unit:
          requires:
            - install-deps
      - test-integration:
          requires:
            - install-deps
      - scan-python-deps:
          context:
            - snyk
          requires:
            - install-deps
      - build-docker:
          context:
            - groundwork_docker
          requires:
            - test-unit
            - test-integration
            - scan-python-deps
          filters:
            branches:
              only: main
      - scan-docker-image:
          context:
            - groundwork_docker
            - groundwork_snyk
          requires:
            - build-docker
          filters:
            branches:
              only: main
      - verify-docker:
          context:
            - groundwork_docker
          requires:
            - build-docker
          filters:
            branches:
              only: main
      - run-production-migrations:
          context:
            - groundwork_supabase
          requires:
            - verify-docker
            - scan-docker-image
          filters:
            branches:
              only: main
      - push-docker:
          context:
            - groundwork_docker
          requires:
            - run-production-migrations
          filters:
            branches:
              only: main
      - deploy-digitalocean:
          context:
            - groundwork_digitalocean
          requires:
            - push-docker
          filters:
            branches:
              only: main
